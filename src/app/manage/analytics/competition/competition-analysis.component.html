<div class="competition-analysis-container">
  <div class="competition-analysis-dashboard">
  <p-toast key="toastmsg"></p-toast>
  <p-confirmDialog></p-confirmDialog>
  
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">Competition Analysis</h1>
        <p class="page-subtitle">Analyze competing venues in your area and compare pricing strategies</p>
        
        <!-- Current Venue Badge -->
        <div class="venue-owner-notice" *ngIf="currentVenue">
          <p-tag severity="info" [value]="'Analyzing for: ' + currentVenue.name" icon="pi pi-building"></p-tag>
          <p-tag severity="warning" [value]="'Within ' + selectedDistanceFilter.label" icon="pi pi-map-marker" class="ml-2"></p-tag>
        </div>
      </div>
      
      <div class="header-actions">
        <!-- Admin Venue Selection -->
        <div class="filter-group admin-venue-selection" *ngIf="isAdmin">
          <label class="filter-label">
            <i class="pi pi-building"></i>
            Select Venue for Analysis
          </label>
          <p-dropdown 
            [options]="availableVenues" 
            [(ngModel)]="selectedVenueForAdmin" 
            optionLabel="label" 
            placeholder="Search and select a venue..."
            (onChange)="onAdminVenueSelection()"
            [filter]="true"
            [filterBy]="'label'"
            filterPlaceholder="Type to search venues..."
            [showClear]="true"
            styleClass="venue-dropdown"
            [style]="{'min-width': '350px'}"
            appendTo="body">
            <ng-template pTemplate="selectedItem">
              <div class="selected-venue" *ngIf="selectedVenueForAdmin">
                <i class="pi pi-building venue-icon"></i>
                <span class="venue-name">{{ selectedVenueForAdmin.value?.name }}</span>
                <span class="venue-location">{{ selectedVenueForAdmin.value?.cityname }}</span>
              </div>
            </ng-template>
            <ng-template pTemplate="item" let-venue>
              <div class="venue-option">
                <div class="venue-details">
                  <span class="venue-name">{{ venue.value?.name }}</span>
                  <span class="venue-location">{{ venue.value?.cityname }}, {{ venue.value?.subarea || 'N/A' }}</span>
                </div>
                <div class="venue-meta">
                  <span class="venue-capacity">{{ getCapacityDisplay(venue.value?.capacity) }}</span>
                  <span class="venue-price" *ngIf="venue.value?.avgPrice">{{ getPriceDisplay(venue.value?.avgPrice) }}</span>
                </div>
              </div>
            </ng-template>
          </p-dropdown>
          <small class="admin-helper-text">
            <i class="pi pi-info-circle"></i>
            As an admin, you can analyze competition for any venue in the system
          </small>
        </div>
        
        <!-- Distance Filter -->
        <div class="filter-group">
          <label class="filter-label">Search Radius</label>
          <p-dropdown 
            [options]="distanceFilters" 
            [(ngModel)]="selectedDistanceFilter" 
            optionLabel="label" 
            placeholder="Select Distance"
            (onChange)="onDistanceFilterChange()"
            styleClass="distance-dropdown">
          </p-dropdown>
        </div>
        
        <!-- Export Actions -->
        <div class="export-actions">
          <button 
            pButton 
            pRipple 
            label="Export PDF" 
            icon="pi pi-file-pdf" 
            class="p-button-outlined p-button-sm"
            (click)="exportToPDF()"
            [disabled]="!filteredVenues.length">
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Overview Stats Cards -->
  <div class="overview-cards">
    <div class="stats-grid">
      <div class="overview-card total-competitors">
        <div class="card-content">
          <div class="icon">
            <i class="pi pi-building"></i>
          </div>
          <div class="stats">
            <h3>{{ statistics?.totalCompetitors || 0 }}</h3>
            <p>Total Competitors</p>
          </div>
        </div>
      </div>
      
      <div class="overview-card avg-price">
        <div class="card-content">
          <div class="icon">
            <i class="pi pi-tag"></i>
          </div>
          <div class="stats">
            <h3>{{ getPriceDisplay(statistics?.avgCompetitorPrice || 0) }}</h3>
            <p>Avg Competitor Price</p>
          </div>
        </div>
      </div>
      
      <div class="overview-card price-range">
        <div class="card-content">
          <div class="icon">
            <i class="pi pi-chart-bar"></i>
          </div>
          <div class="stats">
            <h3>{{ getPriceDisplay(statistics?.minCompetitorPrice || 0) }} - {{ getPriceDisplay(statistics?.maxCompetitorPrice || 0) }}</h3>
            <p>Price Range</p>
          </div>
        </div>
      </div>
      
      <div class="overview-card price-advantage" 
           [ngClass]="{
             'advantage-positive': (statistics?.priceAdvantage || 0) > 0,
             'advantage-negative': (statistics?.priceAdvantage || 0) < 0,
             'advantage-neutral': (statistics?.priceAdvantage || 0) === 0
           }">
        <div class="card-content">
          <div class="icon">
            <i class="pi" [ngClass]="{
              'pi-arrow-up': (statistics?.priceAdvantage || 0) > 0,
              'pi-arrow-down': (statistics?.priceAdvantage || 0) < 0,
              'pi-minus': (statistics?.priceAdvantage || 0) === 0
            }"></i>
          </div>
          <div class="stats">
            <h3>
              <span *ngIf="(statistics?.priceAdvantage || 0) > 0">+</span>{{ statistics ? getPriceDisplay(getAbsoluteValue(statistics?.priceAdvantage || 0)) : 'â‚¹0' }}
            </h3>
            <p>Price Advantage</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Current Venue Summary Card -->
    <div class="current-venue-card" *ngIf="currentVenue">
      <div class="venue-info-section">
        <div class="venue-title">
          <h3>{{ currentVenue.name }}</h3>
          <p-badge value="Your Venue" severity="info" class="venue-badge" *ngIf="!isAdmin"></p-badge>
          <p-badge value="Selected for Analysis" severity="success" class="venue-badge" *ngIf="isAdmin"></p-badge>
        </div>
        <div class="venue-location">
          <i class="pi pi-map-marker location-icon"></i>
          <span>{{ currentVenue.subarea }}, {{ currentVenue.cityname }}</span>
        </div>
      </div>
      <div class="venue-stats-horizontal">
        <div class="stat-item">
          <div class="stat-icon">
            <i class="pi pi-users"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Capacity</span>
            <span class="stat-value">{{ getCapacityDisplay(currentVenue.capacity) }}</span>
          </div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <div class="stat-icon">
            <i class="pi pi-tag"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Avg Price</span>
            <span class="stat-value">{{ getPriceDisplay(currentVenue.avgPrice) }}</span>
          </div>
        </div>
        <div class="stat-divider" *ngIf="(statistics?.avgDistance || 0) > 0"></div>
        <div class="stat-item" *ngIf="(statistics?.avgDistance || 0) > 0">
          <div class="stat-icon">
            <i class="pi pi-compass"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Avg Distance to Competitors</span>
            <span class="stat-value">{{ getDistanceDisplay(statistics?.avgDistance || 0) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Competition Table -->
  <div class="venues-table-section">
    <div class="table-card">
      <div class="table-header">
        <div class="header-content">
          <div>
            <h3>Venue Analysis</h3>
            <p class="text-muted">Your venue and competitors within {{ selectedDistanceFilter.label }}</p>
          </div>
          <div class="table-info">
            <span class="venue-count">{{ filteredVenues.length }} venues found</span>
          </div>
        </div>
      </div>

      <p-table 
        #dt
        [value]="filteredVenues" 
        [loading]="loading"
        [rows]="10"
        [showCurrentPageReport]="true" 
        [rowsPerPageOptions]="[10,25,50]" 
        [paginator]="true"
        [sortField]="'distance'"
        [sortOrder]="1"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} venues"
        [globalFilterFields]="['name','cityname','subarea']"
        styleClass="p-datatable-gridlines modern-table"
        [scrollable]="true"
        [exportFilename]="'competition-analysis'"
        [reorderableColumns]="true"
        [resizableColumns]="true">
        
        <!-- Global Filter -->
        <ng-template pTemplate="caption">
          <div class="table-caption">
            <div class="search-section">
              <span class="p-input-icon-right search-container">
                <input 
                  pInputText 
                  type="text" 
                  [(ngModel)]="searchValue"
                  (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
                  placeholder="Search venues by name..."
                  class="search-input" />
                <i class="pi pi-search search-icon"></i>
              </span>
              <div class="search-hint">
                <i class="pi pi-info-circle"></i>
                <span>Find venues by typing their name</span>
              </div>
            </div>
          </div>
        </ng-template>

        <!-- Table Header -->
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="name" pReorderableColumn class="venue-name-col">
              <div class="flex align-items-center">
                Venue Name
                <p-sortIcon field="name"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="distance" pReorderableColumn class="distance-col">
              <div class="flex align-items-center">
                <span *ngIf="!isAdmin">Distance</span>
                <span *ngIf="isAdmin && currentVenue">Distance from {{ currentVenue.name }}</span>
                <span *ngIf="isAdmin && !currentVenue">Distance</span>
                <p-sortIcon field="distance"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="cityname" pReorderableColumn class="location-col">
              <div class="flex align-items-center">
                Location
                <p-sortIcon field="cityname"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="capacity" pReorderableColumn class="capacity-col">
              <div class="flex align-items-center">
                Capacity
                <p-sortIcon field="capacity"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="avgPrice" pReorderableColumn class="price-col">
              <div class="flex align-items-center">
                Avg Price
                <p-sortIcon field="avgPrice"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="vegPrice" pReorderableColumn class="price-col">
              <div class="flex align-items-center">
                Veg Price
                <p-sortIcon field="vegPrice"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="nonVegPrice" pReorderableColumn class="price-col">
              <div class="flex align-items-center">
                Non-Veg Price
                <p-sortIcon field="nonVegPrice"></p-sortIcon>
              </div>
            </th>

            <th pSortableColumn="rating" pReorderableColumn class="rating-col">
              <div class="flex align-items-center">
                Ratings
                <p-sortIcon field="rating"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="isAssured" pReorderableColumn class="assured-col">
              <div class="flex align-items-center">
                Assured
                <p-sortIcon field="isAssured"></p-sortIcon>
              </div>
            </th>
          </tr>
        </ng-template>

        <!-- Table Body -->
        <ng-template pTemplate="body" let-venue>
          <tr [ngClass]="{
            'current-venue-row': venue.isCurrentVenue, 
            'competitor-venue-row': !venue.isCurrentVenue
          }">
            <td class="venue-name-cell">
              <div class="venue-name-container">
                <a 
                  [routerLink]="['/venue', venue.metaUrl || venue.id]"
                  [title]="venue.name"
                  class="venue-name-link"
                  [ngClass]="{
                    'current-venue-name': venue.isCurrentVenue
                  }">
                  <span class="venue-name">{{ venue.name }}</span>
                </a>
                <p-badge 
                  *ngIf="venue.isCurrentVenue" 
                  value="Your Venue" 
                  severity="success"
                  class="venue-badge">
                </p-badge>
              </div>
            </td>
            <td class="distance-cell">
              <span class="distance-value">{{ getDistanceDisplay(venue.distance) }}</span>
            </td>
            <td class="location-cell">
              <div class="location-info">
                <div class="city-name">{{ venue.cityname }}</div>
                <div class="subarea-name" *ngIf="venue.subarea">{{ venue.subarea }}</div>
              </div>
            </td>
            <td class="capacity-cell">
              <span class="capacity-value">{{ getCapacityDisplay(venue.capacity) }}</span>
            </td>
            <td class="price-cell">
              <span class="price-value primary-price">{{ getPriceDisplay(venue.avgPrice) }}</span>
            </td>
            <td class="price-cell">
              <span class="price-value">{{ getPriceDisplay(venue.vegPrice) }}</span>
            </td>
            <td class="price-cell">
              <span class="price-value">{{ getPriceDisplay(venue.nonVegPrice) }}</span>
            </td>

            <td class="rating-cell">
              <div class="review-list-vertical">
                <div class="icon-review eazy-venue-ratings" *ngIf="venue.eazyVenueRating && venue.eazyVenueRating > 0">
                  <img src="assets/images/logo.png" alt="EazyVenue ratings icon" />
                  <i class="pi pi-star-fill" style="font-size: 12px">
                    <span class="rating-style">
                      <b>{{ getRatingDisplay(venue.eazyVenueRating) }}</b>/5
                    </span>
                  </i>
                </div>
                <div class="icon-review google-ratings" *ngIf="venue.googleRating && venue.googleRating > 0">
                  <img src="assets/img/svg/google.png" alt="Google ratings icon" />
                  <i class="pi pi-star-fill" style="font-size: 12px">
                    <span class="rating-style">
                      <b>{{ getRatingDisplay(venue.googleRating) }}</b>/5
                    </span>
                  </i>
                </div>
                <div class="no-ratings" *ngIf="(!venue.eazyVenueRating || venue.eazyVenueRating === 0) && (!venue.googleRating || venue.googleRating === 0)">
                  <i class="pi pi-star rating-empty-icon"></i>
                  <span class="no-rating">No ratings</span>
                </div>
              </div>
            </td>
            <td class="assured-cell">
              <p-badge 
                [value]="getAssuredDisplay(venue.isAssured)"
                [severity]="venue.isAssured ? 'success' : 'secondary'"
                class="assured-badge">
              </p-badge>
            </td>
          </tr>
        </ng-template>

        <!-- Empty State -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="getColumnCount()" class="empty-state-cell">
              <div class="empty-state-container">
                <div class="empty-state-content">
                  <!-- Admin Empty State -->
                  <div class="admin-empty-state" *ngIf="isAdmin && !currentVenue">
                    <!-- <div class="empty-state-icon">
                      <i class="pi pi-building"></i>
                    </div> -->
                    <div class="empty-state-message">
                      <h3>Select a Venue to Analyze</h3>
                      <!-- <p>Choose a venue from the dropdown above to view detailed competition analysis and compare pricing strategies with nearby competitors.</p> -->
                    </div>
                    <div class="empty-state-instructions">
                      <div class="instruction-step">
                        <div class="step-number">1</div>
                        <div class="step-text">Use the venue selector dropdown above</div>
                      </div>
                      <div class="instruction-step">
                        <div class="step-number">2</div>
                        <div class="step-text">Search and select a venue</div>
                      </div>
                      <div class="instruction-step">
                        <div class="step-number">3</div>
                        <div class="step-text">View comprehensive analysis results</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Regular Empty State -->
                  <div class="regular-empty-state" *ngIf="!isAdmin || currentVenue">
                    <div class="empty-state-icon">
                      <i class="pi pi-search"></i>
                    </div>
                    <div class="empty-state-message">
                      <h3>No Competing Venues Found</h3>
                      <p>No venues found within the selected distance. Try adjusting your search radius or location settings.</p>
                    </div>
                    <div class="empty-state-suggestions">
                      <div class="suggestion-item">
                        <i class="pi pi-map-marker"></i>
                        <span>Increase search radius</span>
                      </div>
                      <div class="suggestion-item">
                        <i class="pi pi-refresh"></i>
                        <span>Check location settings</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Debug Section (for development only) -->
  <div class="debug-section" *ngIf="false">
    <div class="debug-card">
  </div>
</div>
</div>