<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<div class="dashboard-container">
    <div class="dashboard-header">
        <div class="header-content">
            <h2 class="dashboard-title">
                <i class="fas fa-building"></i>
                Venue Enquiry Dashboard
            </h2>
            <div class="header-stats">
       <button
    class="action-btn add-enquiry-btn"
    (click)="openAddEnquiryModal()"
    *ngIf="!isVenueOwner"
    title="Add Manual Enquiries">
    <i class="fas fa-plus"></i>
    Add Enquiries
</button>
<button pButton type="button" (click)="exportEnquiriesToCSV()" label="Export CSV" icon="pi pi-download" class="p-button-success"></button>
<!-- Update only the filter section in your HTML -->
<div class="filter-dropdown">
    <button
        class="stat-badge filter-button"
        (click)="toggleVenueFilter()"
        [class.active]="showVenueFilter">
        <i class="fas fa-filter"></i>
        {{selectedVenueFilter ? getSelectedVenueInfo() : totalRecords + ' Total Venues'}}
        <i class="fas fa-chevron-down" [class.rotate]="showVenueFilter"></i>
    </button>

    <!-- Add overlay for mobile -->
    <div class="filter-overlay"
         *ngIf="showVenueFilter"
         (click)="clearVenueFilter()">
    </div>

    <div class="venue-filter-dropdown" *ngIf="showVenueFilter">
        <div class="filter-header">
            <span>Filter by Venue</span>
            <button class="clear-filter" (click)="clearVenueFilter()" *ngIf="selectedVenueFilter">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="venue-options">
            <div
                class="venue-option"
                *ngFor="let venue of uniqueVenues"
                (click)="selectVenueFilter(venue)"
                [class.selected]="selectedVenueFilter === venue.id">
                <span class="venue-name">{{venue.name}}</span>
                <span class="venue-count">{{venue.totalLeads}} leads</span>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>

    <div class="table-wrapper">
<p-table
    [value]="getDisplayEnquiries()"
    [loading]="loading"
    [paginator]="true"
    [rows]="10"
    [totalRecords]="getDisplayEnquiries().length"
    styleClass="modern-datatable">

            <ng-template pTemplate="header">
                <tr>
                    <th class="venue-col">Venue Details</th>
                    <th class="user-col">Contact Info</th>
                    <th class="leads-col">Leads</th>
                    <th class="date-col">Latest Activity</th>
                    <th class="status-col">Status</th>
                    <th class="actions-col">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-enquiry>
                <tr class="data-row">
                    <td class="venue-cell">
    <div class="venue-info">
        <div class="venue-name">
            <i class="fas fa-map-marker-alt venue-icon"></i>
            <strong>{{enquiry.venueName}}</strong>
        </div>

        <!-- Show lead info when venue filter is active -->
        <div *ngIf="selectedVenueFilter" class="lead-indicator">
            <span class="lead-number">Lead {{enquiry.leadIndex}}</span>
        </div>
    </div>
</td>

                    <td class="contact-cell">
                        <div class="contact-info">
                            <div class="user-name">
                                <i class="fas fa-user"></i>
                                {{getCurrentUser(enquiry).userName}}
                            </div>
                            <div class="user-contact">
                                <i class="fas fa-phone-alt"></i>
                                {{getCurrentUser(enquiry).userContact}}
                            </div>
                        </div>
                    </td>

                    <td class="leads-cell">
    <div class="leads-count">
        <!-- Show clickable total count when no filter and multiple leads -->
        <span class="leads-badge clickable-leads"
              *ngIf="!selectedVenueFilter && enquiry.leadCount > 1"
              (click)="toggleLeadsExpansion(enquiry)"
              [class.expanded]="isLeadsExpanded(enquiry)"
              title="Click to view all leads">
            {{enquiry.leadCount}}
            <i class="fas fa-chevron-down expand-icon" [class.rotated]="isLeadsExpanded(enquiry)"></i>
        </span>

        <!-- Show non-clickable count for single lead -->
        <span class="leads-badge" *ngIf="!selectedVenueFilter && enquiry.leadCount <= 1">{{enquiry.leadCount}}</span>

        <!-- Show "1 of X" when filtered -->
        <span class="leads-badge" *ngIf="selectedVenueFilter">1</span>

        <small *ngIf="!selectedVenueFilter">leads</small>
        <small *ngIf="selectedVenueFilter">of {{enquiry.originalLeadCount}}</small>
    </div>
</td>

                    <td class="date-cell">
                        <div class="date-info">
                            <i class="fas fa-calendar-alt"></i>
                            <span>{{getCurrentUser(enquiry).created_at | date:'dd/MM/yyyy'}}</span>
                            <small>{{getCurrentUser(enquiry).created_at | date:'HH:mm'}}</small>
                        </div>
                    </td>

                    <td class="status-cell">
                        <span class="status-indicator"
                              [ngClass]="{
                                'status-whatsapp': getCurrentUser(enquiry).status === 'WhatsApp Contacted',
                                'status-phone': getCurrentUser(enquiry).status === 'Phone Contacted',
                                'status-new': getCurrentUser(enquiry).status === 'New',
                                'status-closed': getCurrentUser(enquiry).status === 'Closed'
                              }">
                            <i class="fas fa-circle"></i>
                            {{getCurrentUser(enquiry).status}}
                        </span>
                    </td>

                    <td class="actions-cell">
                        <div class="action-buttons">
                            <button
                                class="action-btn whatsapp-btn"
                                (click)="contactViaWhatsApp(enquiry)"
                                title="Contact via WhatsApp"
                                [disabled]="getCurrentUser(enquiry).status === 'WhatsApp Contacted'">
                                <i class="fab fa-whatsapp"></i>
                            </button>

                            <button
                                class="action-btn phone-btn"
                                (click)="contactViaPhone(enquiry)"
                                title="Contact via Phone"
                                [disabled]="getCurrentUser(enquiry).status === 'Phone Contacted'">
                                <i class="fas fa-phone"></i>
                            </button>
                        </div>
                    </td>
                </tr>

                <!-- Expanded Leads List Row -->
                <tr *ngIf="isLeadsExpanded(enquiry) && !selectedVenueFilter" class="expanded-row">
                    <td colspan="6" class="expanded-content">
                        <div class="leads-list-container">
                            <div class="leads-list-header">
                                <h6><i class="fas fa-users"></i> All Leads for {{enquiry.venueName}} ({{enquiry.leadCount}} total)</h6>
                                <button class="collapse-btn" (click)="toggleLeadsExpansion(enquiry)" title="Collapse">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>

                            <div class="leads-list">
                                <div class="lead-item" *ngFor="let lead of getAllLeadsForVenue(enquiry); let i = index">
                                    <div class="lead-number-badge">
                                        <span>{{i + 1}}</span>
                                    </div>

                                    <div class="lead-info">
                                        <div class="lead-contact">
                                            <div class="contact-name">
                                                <i class="fas fa-user"></i>
                                                <strong>{{lead.userName}}</strong>
                                            </div>
                                            <div class="contact-phone">
                                                <i class="fas fa-phone-alt"></i>
                                                {{lead.userContact}}
                                            </div>
                                            <div class="contact-email" *ngIf="lead.userEmail">
                                                <i class="fas fa-envelope"></i>
                                                {{lead.userEmail}}
                                            </div>
                                        </div>

                                        <div class="lead-meta">
                                            <div class="lead-date">
                                                <i class="fas fa-calendar-alt"></i>
                                                {{lead.created_at | date:'dd/MM/yyyy HH:mm'}}
                                            </div>
                                            <div class="lead-status">
                                                <span class="status-indicator"
                                                      [ngClass]="{
                                                        'status-whatsapp': lead.status === 'WhatsApp Contacted',
                                                        'status-phone': lead.status === 'Phone Contacted',
                                                        'status-new': lead.status === 'New',
                                                        'status-closed': lead.status === 'Closed'
                                                      }">
                                                    <i class="fas fa-circle"></i>
                                                    {{lead.status}}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="lead-actions">
                                        <button
                                            class="action-btn whatsapp-btn"
                                            (click)="contactViaWhatsAppForLead(lead, enquiry)"
                                            title="Contact via WhatsApp"
                                            [disabled]="lead.status === 'WhatsApp Contacted'">
                                            <i class="fab fa-whatsapp"></i>
                                        </button>

                                        <button
                                            class="action-btn phone-btn"
                                            (click)="contactViaPhoneForLead(lead, enquiry)"
                                            title="Contact via Phone"
                                            [disabled]="lead.status === 'Phone Contacted'">
                                            <i class="fas fa-phone"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="empty-state">
                        <div class="empty-content">
                            <i class="fas fa-search"></i>
                            <h4>No enquiries found</h4>
                            <p>Try adjusting your filters or check back later</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
<div class="modal-overlay" *ngIf="showAddEnquiryModal" (click)="closeAddEnquiryModal()">
    <div class="add-enquiry-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> Add Manual Enquiries</h3>
            <button class="close-btn" (click)="closeAddEnquiryModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="enquiry-form-container">
            <!-- Venue Selection Section -->
            <div class="venue-selection-section">
                <div class="form-group">
                    <label>Select Venue(s) *</label>
                    <p-multiSelect
                        [options]="venueOptions"
                        [(ngModel)]="selectedVenues"
                        placeholder="Search and select venues..."
                        [filter]="true"
                        filterBy="label"
                        optionLabel="label"
                        optionValue="value"
                        [showClear]="true"
                        [maxSelectedLabels]="2"
                        selectedItemsLabel="{0} venues selected"
                        styleClass="venue-multi-select">
                    </p-multiSelect>
                    <small class="help-text">
                        <i class="fas fa-info-circle"></i>
                        Select one or more venues. Each lead will be added to all selected venues.
                    </small>
                </div>
            </div>

            <!-- Bulk Leads Entry Section -->
            <div class="bulk-leads-section">
                <div class="section-header">
                    <h4><i class="fas fa-users"></i> Customer Details</h4>
                    <div class="bulk-actions">
                        <button type="button"
                                class="btn btn-outline-primary btn-sm"
                                (click)="addNewLead()"
                                [disabled]="leadEntries.length >= 10">
                            <i class="fas fa-plus"></i>
                            Add Lead
                        </button>
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm"
                                (click)="clearAllLeads()"
                                *ngIf="leadEntries.length > 1">
                            <i class="fas fa-trash"></i>
                            Clear All
                        </button>
                    </div>
                </div>

                <div class="leads-container">
                    <div class="lead-entry"
                         *ngFor="let lead of leadEntries; let i = index; trackBy: trackByLeadId">
                        <div class="lead-header">
                            <span class="lead-number">Lead #{{ i + 1 }}</span>
                            <button type="button"
                                    class="remove-lead-btn"
                                    (click)="removeLead(i)"
                                    *ngIf="leadEntries.length > 1"
                                    title="Remove this lead">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="lead-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Customer Name *</label>
                                    <input type="text"
                                           [(ngModel)]="lead.userName"
                                           placeholder="Enter customer name"
                                           class="form-control"
                                           [class.error]="!lead.userName && showValidationErrors">
                                </div>

                                <div class="form-group">
                                    <label>Contact Number *</label>
                                    <input type="tel"
                                           [(ngModel)]="lead.userContact"
                                           placeholder="Enter contact number"
                                           class="form-control"
                                           [class.error]="!lead.userContact && showValidationErrors"
                                           (input)="validateContactNumber(lead)">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email"
                                           [(ngModel)]="lead.userEmail"
                                           placeholder="Enter email address"
                                           class="form-control"
                                           [class.error]="lead.userEmail && !isValidEmail(lead.userEmail) && showValidationErrors">
                                </div>

                                <div class="form-group">
                                    <label>Status</label>
                                    <p-dropdown
                                        [options]="statusOptions"
                                        [(ngModel)]="lead.status"
                                        placeholder="Select status"
                                        optionLabel="label"
                                        optionValue="value"
                                        styleClass="status-dropdown"
                                        >
                                    </p-dropdown>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Enquiry Date *</label>
                                    <p-calendar
                                        [(ngModel)]="lead.enquiryDate"
                                        [showTime]="true"
                                        [hourFormat]="24"
                                        dateFormat="dd/mm/yy"
                                        placeholder="Select date & time"
                                        styleClass="calendar-control"
                                        >
                                    </p-calendar>
                                </div>

                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea
                                        [(ngModel)]="lead.notes"
                                        placeholder="Add notes for this lead..."
                                        class="form-control textarea-control"
                                        rows="2">
                                    </textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="add-more-section" *ngIf="leadEntries.length < 10">
                    <button type="button"
                            class="btn btn-dashed"
                            (click)="addNewLead()">
                        <i class="fas fa-plus"></i>
                        Add Another Lead ({{ leadEntries.length }}/10)
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="form-actions">
                <button type="button"
                        class="btn btn-secondary"
                        (click)="closeAddEnquiryModal()">
                    Cancel
                </button>
                <button type="button"
                        class="btn btn-primary"
                        (click)="submitBulkEnquiries()"
                        [disabled]="!isFormValid() || submittingEnquiry">
                    <i class="fas fa-save" *ngIf="!submittingEnquiry"></i>
                    <i class="fas fa-spinner fa-spin" *ngIf="submittingEnquiry"></i>
                    {{ submittingEnquiry ? 'Saving...' : 'Save All Enquiries' }}
                </button>
            </div>

            <!-- Summary Section -->
            <div class="summary-section" *ngIf="selectedVenues.length > 0 && leadEntries.length > 0">
                <div class="summary-info">
                    <i class="fas fa-info-circle"></i>
                    <span>
                        Total entries to be created:
                        <strong>{{ selectedVenues.length }} venue(s) Ã— {{ getValidLeadsCount() }} lead(s) = {{ selectedVenues.length * getValidLeadsCount() }} enquiries</strong>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
