<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<div class="dashboard-container">
    <!-- ðŸš€ REVOLUTIONARY LIVE ALERTS BAR -->
    <div class="live-alerts-bar" *ngIf="realTimeAlerts.length > 0">
        <div class="alert-ticker">
            <i class="fas fa-broadcast-tower pulse-icon"></i>
            <span class="alert-label">LIVE INSIGHTS:</span>
            <div class="scrolling-alerts">
                <div class="alert-item"
                     *ngFor="let alert of realTimeAlerts.slice(0, 3)"
                     [class]="'alert-' + alert.severity"
                     (click)="openBehaviorPanel(alert.enquiry)">
                    <span class="alert-text">{{alert.message}}</span>
                    <span class="alert-time">{{formatTimeAgo(alert.timestamp.toISOString())}}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-header">
        <div class="header-content">
            <div class="title-section">
                <h2 class="dashboard-title">
                    <i class="fas fa-building"></i>
                    <span class="title-text">Venue Enquiry Dashboard</span>
                    <span class="live-indicator">
                        <i class="fas fa-circle pulse-dot"></i>
                        <span class="live-text">LIVE TRACKING ACTIVE</span>
                    </span>
                </h2>
            </div>
            <div class="header-stats">
                <button
                    class="action-btn add-enquiry-btn"
                    (click)="openAddEnquiryModal()"
                    *ngIf="!isVenueOwner"
                    title="Add Manual Enquiries">
                    <i class="fas fa-plus"></i>
                    <span class="btn-text">Add Enquiries</span>
                </button>
                <button
                    class="action-btn import-csv-btn"
                    (click)="openImportCsvModal()"
                    *ngIf="!isVenueOwner"
                    title="Import CSV Leads">
                    <i class="fas fa-file-csv"></i>
                    <span class="btn-text">Import CSV</span>
                </button>
                <button
                    class="action-btn export-btn"
                    (click)="exportEnquiriesToCSV()"
                    title="Export to CSV">
                    <i class="pi pi-download"></i>
                    <span class="btn-text">Export CSV</span>
                </button>
                <!-- Update only the filter section in your HTML -->
<div class="filter-dropdown">
    <button
        class="stat-badge filter-button"
        (click)="toggleVenueFilter()"
        [class.active]="showVenueFilter">
        <i class="fas fa-filter"></i>
        <span class="filter-text">{{selectedVenueFilter ? getSelectedVenueInfo() : totalRecords + ' Total Venues'}}</span>
        <i class="fas fa-chevron-down" [class.rotate]="showVenueFilter"></i>
    </button>

    <!-- Add overlay for mobile -->
    <div class="filter-overlay"
         *ngIf="showVenueFilter"
         (click)="clearVenueFilter()">
    </div>

    <div class="venue-filter-dropdown" *ngIf="showVenueFilter">
        <div class="filter-header">
            <span>Filter by Venue</span>
            <button class="clear-filter" (click)="clearVenueFilter()" *ngIf="selectedVenueFilter">
                <i class="fas fa-times"></i>
            </button>
        </div>
                
        <!-- Search Input -->
        <div class="venue-search-container">
            <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input 
                    type="text" 
                    class="venue-search-input" 
                    placeholder="Search venues..." 
                    [(ngModel)]="venueSearchText"
                    (input)="searchVenues()"
                    (keyup.escape)="clearVenueSearch()">
                <button 
                    class="clear-search-btn" 
                    *ngIf="venueSearchText" 
                    (click)="clearVenueSearch()"
                    title="Clear search">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Venues List -->
        <div class="venue-options">
            <div class="no-venues-found" *ngIf="filteredUniqueVenues.length === 0 && venueSearchText">
                <i class="fas fa-search"></i>
                <span>No venues found matching "{{venueSearchText}}"</span>
            </div>
            <div
                class="venue-option"
                *ngFor="let venue of filteredUniqueVenues"
                (click)="selectVenueFilter(venue)"
                [class.selected]="selectedVenueFilter === venue.id">
                <span class="venue-name">{{venue.name}}</span>
                <span class="venue-count">{{venue.totalLeads}} leads</span>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>

    <!-- Desktop Table View -->
    <div class="table-wrapper desktop-view">
<p-table
    [value]="getDisplayEnquiries()"
    [loading]="loading"
    [paginator]="true"
    [rows]="10"
    [totalRecords]="getDisplayEnquiries().length"
    styleClass="modern-datatable">

            <ng-template pTemplate="header">
                <tr>
                    <th class="venue-col">Venue Details</th>
                    <th class="user-col">Contact Info</th>
                    <th class="event-col">Event Details</th>
                    <th class="platform-col">Source</th>
                    <th class="leads-col">Leads</th>
                    <th class="date-col">Latest Activity</th>
                    <th class="status-col">Status</th>
                    <th class="live-col">ðŸ”® Live Insights</th>
                    <th class="ai-col">ðŸ§  AI Score</th>
                    <th class="actions-col">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-enquiry>
                <tr class="data-row">
                    <td class="venue-cell">
    <div class="venue-info">
        <!-- <div class="venue-name"> -->
            <div class="venue-name" [attr.data-venue-name]="enquiry.venueName">
            <i class="fas fa-map-marker-alt venue-icon"></i>
            <strong>{{enquiry.venueName}}</strong>
            <!-- Call tracking indicator -->
            <span class="call-tracking-badge" 
                  *ngIf="getVenueCallCount(enquiry.venueId || enquiry.id) > 0"
                  title="{{getVenueCallCount(enquiry.venueId || enquiry.id)}} calls tracked">
                <i class="fas fa-phone"></i>
                {{getVenueCallCount(enquiry.venueId || enquiry.id)}}
            </span>
        </div>

        <!-- Show lead info when venue filter is active -->
        <div *ngIf="selectedVenueFilter" class="lead-indicator">
            <span class="lead-number">Lead {{enquiry.leadIndex}}</span>
        </div>
    </div>
</td>

                    <td class="contact-cell">
                        <div class="contact-info">
                            <div class="user-name">
                                <i class="fas fa-user"></i>
                                {{getCurrentUser(enquiry).userName}}
                            </div>
                            <div class="user-contact">
                                <i class="fas fa-phone-alt"></i>
                                {{getCurrentUser(enquiry).userContact}}
                            </div>
                        </div>
                    </td>

                    <!-- Event Details Column -->
                    <td class="event-cell">
                        <div class="event-info">
                            <div class="event-type" *ngIf="getCurrentUser(enquiry).eventType">
                                <i class="fas fa-heart" *ngIf="getCurrentUser(enquiry).eventType.toLowerCase().includes('wedding')"></i>
                                <i class="fas fa-glass-cheers" *ngIf="getCurrentUser(enquiry).eventType.toLowerCase().includes('reception')"></i>
                                <i class="fas fa-birthday-cake" *ngIf="getCurrentUser(enquiry).eventType.toLowerCase().includes('birthday')"></i>
                                <i class="fas fa-calendar-check" *ngIf="!getCurrentUser(enquiry).eventType.toLowerCase().includes('wedding') && !getCurrentUser(enquiry).eventType.toLowerCase().includes('reception') && !getCurrentUser(enquiry).eventType.toLowerCase().includes('birthday')"></i>
                                <span>{{getEventTypeDisplay(getCurrentUser(enquiry).eventType)}}</span>
                            </div>
                            <div class="event-date" *ngIf="getCurrentUser(enquiry).eventDate">
                                <i class="fas fa-calendar"></i>
                                <small>{{getCurrentUser(enquiry).eventDate}}</small>
                            </div>
                            <div class="no-event-info" *ngIf="!getCurrentUser(enquiry).eventType && !getCurrentUser(enquiry).eventDate">
                                <i class="fas fa-question-circle"></i>
                                <small>N/A</small>
                            </div>
                        </div>
                    </td>

                    <!-- Platform/Source Column -->
                    <td class="platform-cell">
                        <div class="platform-info">
                            <div class="platform-badge" *ngIf="getCurrentUser(enquiry).platform">
                                <i class="fab fa-facebook" *ngIf="getCurrentUser(enquiry).platform === 'fb'"></i>
                                <i class="fab fa-instagram" *ngIf="getCurrentUser(enquiry).platform === 'ig'"></i>
                                <i class="fas fa-globe" *ngIf="getCurrentUser(enquiry).platform !== 'fb' && getCurrentUser(enquiry).platform !== 'ig'"></i>
                                <span>{{getPlatformDisplay(getCurrentUser(enquiry).platform)}}</span>
                            </div>
                            <div class="manual-entry" *ngIf="!getCurrentUser(enquiry).platform">
                                <i class="fas fa-user-edit"></i>
                                <small>Manual</small>
                            </div>
                        </div>
                    </td>

                    <td class="leads-cell">
    <div class="leads-count">
        <!-- Show clickable total count when no filter and multiple leads -->
        <span class="leads-badge clickable-leads"
              *ngIf="!selectedVenueFilter && enquiry.leadCount > 1"
              (click)="toggleLeadsExpansion(enquiry)"
              [class.expanded]="isLeadsExpanded(enquiry)"
              title="Click to view all leads">
            {{enquiry.leadCount}}
            <i class="fas fa-chevron-down expand-icon" [class.rotated]="isLeadsExpanded(enquiry)"></i>
        </span>

        <!-- Show non-clickable count for single lead -->
        <span class="leads-badge" *ngIf="!selectedVenueFilter && enquiry.leadCount <= 1">{{enquiry.leadCount}}</span>

        <!-- Show "1 of X" when filtered -->
        <span class="leads-badge" *ngIf="selectedVenueFilter">1</span>

        <small *ngIf="!selectedVenueFilter">leads</small>
        <small *ngIf="selectedVenueFilter">of {{enquiry.originalLeadCount}}</small>
    </div>
</td>

                    <td class="date-cell">
                        <div class="date-info">
                            <i class="fas fa-calendar-alt"></i>
                            <span>{{getCurrentUser(enquiry).created_at | date:'dd/MM/yyyy'}}</span>
                            <small>{{getCurrentUser(enquiry).created_at | date:'HH:mm'}}</small>
                        </div>
                    </td>

                    <td class="status-cell">
                        <div class="status-display">
                            <span class="status-indicator"
                                  [ngClass]="{
                                    'status-whatsapp': getCurrentUser(enquiry).whatsappClickCount > 0,
                                    'status-phone': getCurrentUser(enquiry).phoneClickCount > 0,
                                    'status-both': getCurrentUser(enquiry).whatsappClickCount > 0 && getCurrentUser(enquiry).phoneClickCount > 0,
                                    'status-new': (!getCurrentUser(enquiry).whatsappClickCount && !getCurrentUser(enquiry).phoneClickCount) || getCurrentUser(enquiry).status === 'New',
                                    'status-closed': getCurrentUser(enquiry).status === 'Closed'
                                  }">
                                <i class="fas fa-circle"></i>
                                <span class="status-text">
                                    <span *ngIf="getCurrentUser(enquiry).whatsappClickCount > 0" class="click-count">
                                        <i class="fab fa-whatsapp"></i> {{getCurrentUser(enquiry).whatsappClickCount}}x
                                    </span>
                                    <span *ngIf="getCurrentUser(enquiry).phoneClickCount > 0" class="click-count">
                                        <i class="fas fa-phone"></i> {{getCurrentUser(enquiry).phoneClickCount}}x
                                    </span>
                                    <span *ngIf="!getCurrentUser(enquiry).whatsappClickCount && !getCurrentUser(enquiry).phoneClickCount">
                                        {{getCurrentUser(enquiry).status || 'New'}}
                                    </span>
                                </span>
                            </span>
                        </div>
                    </td>

                    <!-- ðŸ”® REVOLUTIONARY LIVE INSIGHTS COLUMN -->
                    <td class="live-tracking-cell">
                        <div class="live-insights" *ngIf="getLiveTrackingData(enquiry)">
                            <!-- Live Status Indicator -->
                            <div class="live-status"
                                 [class.online]="getLiveTrackingData(enquiry).websiteActivity.currentlyOnSite">
                                <i class="fas fa-circle"
                                   [class.pulse-dot]="getLiveTrackingData(enquiry).websiteActivity.currentlyOnSite"></i>
                                <span>{{getLiveTrackingData(enquiry).websiteActivity.currentlyOnSite ? 'LIVE' : 'Offline'}}</span>
                            </div>

                            <!-- Website Activity Summary -->
                            <div class="activity-summary">
                                <div class="activity-item">
                                    <i class="fas fa-eye"></i>
                                    <span>{{getLiveTrackingData(enquiry).websiteActivity.totalVisits}} visits</span>
                                </div>
                                <div class="activity-item"
                                     *ngIf="getLiveTrackingData(enquiry).competitorAnalysis.priceComparisons">
                                    <i class="fas fa-exclamation-triangle warning-icon"></i>
                                    <span>Price comparing</span>
                                </div>
                            </div>

                            <!-- Quick Insights -->
                            <div class="quick-insights">
                                <span class="urgency-badge"
                                      [class]="getUrgencyBadgeClass(getLiveTrackingData(enquiry).aiInsights.urgencyLevel)">
                                    {{getLiveTrackingData(enquiry).aiInsights.urgencyLevel}}
                                </span>
                            </div>

                            <!-- Behavior Panel Button -->
                            <button class="insight-btn"
                                    (click)="openBehaviorPanel(enquiry)"
                                    title="View Full Behavior Analysis">
                                <i class="fas fa-chart-line"></i>
                            </button>
                        </div>
                    </td>

                    <!-- ðŸ§  AI PROBABILITY SCORE COLUMN -->
                    <td class="ai-score-cell">
                        <div class="ai-probability" *ngIf="getLiveTrackingData(enquiry)">
                            <!-- Probability Circle -->
                            <div class="probability-circle">
                                <div class="circle-progress"
                                     [style.background]="'conic-gradient(' + getBookingProbabilityColor(getLiveTrackingData(enquiry).aiInsights.bookingProbability) + ' ' + (getLiveTrackingData(enquiry).aiInsights.bookingProbability * 3.6) + 'deg, #e0e0e0 0deg)'">
                                    <div class="circle-inner">
                                        <span class="percentage">{{getLiveTrackingData(enquiry).aiInsights.bookingProbability}}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- AI Predictions -->
                            <div class="ai-predictions">
                                <div class="prediction-item">
                                    <i class="fas fa-clock"></i>
                                    <small>{{getLiveTrackingData(enquiry).aiInsights.decisionTimeline}}</small>
                                </div>
                                <div class="prediction-item">
                                    <i class="fas fa-user-tie"></i>
                                    <small>{{getLiveTrackingData(enquiry).aiInsights.personalityType}}</small>
                                </div>
                            </div>

                            <!-- High Probability Alert -->
                            <div class="high-probability-alert"
                                 *ngIf="getLiveTrackingData(enquiry).aiInsights.bookingProbability >= 80">
                                <i class="fas fa-fire"></i>
                                <span>HOT LEAD!</span>
                            </div>
                        </div>
                    </td>

                    <td class="actions-cell">
                        <div class="action-buttons">
                            <button
                                class="action-btn whatsapp-btn"
                                (click)="contactViaWhatsApp(enquiry)"
                                title="Contact via WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                                <span class="btn-text">WhatsApp</span>
                            </button>

                            <button
                                class="action-btn phone-btn"
                                (click)="contactViaPhone(enquiry)"
                                title="Contact via Phone">
                                <i class="fas fa-phone"></i>
                                <span class="btn-text">Call</span>
                            </button>

                            <button
                                class="action-btn delete-btn"
                                (click)="deleteLead(enquiry)"
                                title="Delete this lead">
                                <i class="fas fa-trash-alt"></i>
                                <span class="btn-text">Delete</span>
                            </button>
                        </div>
                    </td>
                </tr>

                <!-- Expanded Leads List Row -->
                <tr *ngIf="isLeadsExpanded(enquiry) && !selectedVenueFilter" class="expanded-row">
                    <td colspan="8" class="expanded-content">
                        <div class="leads-list-container">
                            <div class="leads-list-header">
                                <h6><i class="fas fa-users"></i> All Leads for {{enquiry.venueName}} ({{enquiry.leadCount}} total)</h6>
                                <button class="collapse-btn" (click)="toggleLeadsExpansion(enquiry)" title="Collapse">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>

                            <div class="leads-list">
                                <div class="lead-item" *ngFor="let lead of getAllLeadsForVenue(enquiry); let i = index">
                                    <div class="lead-number-badge">
                                        <span>{{i + 1}}</span>
                                    </div>

                                    <div class="lead-info">
                                        <div class="lead-contact">
                                            <div class="contact-name">
                                                <i class="fas fa-user"></i>
                                                <strong>{{lead.userName}}</strong>
                                            </div>
                                            <div class="contact-phone">
                                                <i class="fas fa-phone-alt"></i>
                                                {{lead.userContact}}
                                            </div>
                                            <div class="contact-email" *ngIf="lead.userEmail">
                                                <i class="fas fa-envelope"></i>
                                                {{lead.userEmail}}
                                            </div>
                                        </div>

                                        <!-- Event Details for Expanded Lead -->
                                        <div class="lead-event-details" *ngIf="lead.eventType || lead.eventDate">
                                            <div class="event-type" *ngIf="lead.eventType">
                                                <i class="fas fa-heart" *ngIf="lead.eventType.toLowerCase().includes('wedding')"></i>
                                                <i class="fas fa-glass-cheers" *ngIf="lead.eventType.toLowerCase().includes('reception')"></i>
                                                <i class="fas fa-birthday-cake" *ngIf="lead.eventType.toLowerCase().includes('birthday')"></i>
                                                <i class="fas fa-calendar-check" *ngIf="!lead.eventType.toLowerCase().includes('wedding') && !lead.eventType.toLowerCase().includes('reception') && !lead.eventType.toLowerCase().includes('birthday')"></i>
                                                <span>{{getEventTypeDisplay(lead.eventType)}}</span>
                                            </div>
                                            <div class="event-date" *ngIf="lead.eventDate">
                                                <i class="fas fa-calendar"></i>
                                                <span>{{lead.eventDate}}</span>
                                            </div>
                                        </div>

                                        <!-- Platform/Source for Expanded Lead -->
                                        <div class="lead-platform" *ngIf="lead.platform">
                                            <div class="platform-badge">
                                                <i class="fab fa-facebook" *ngIf="lead.platform === 'fb'"></i>
                                                <i class="fab fa-instagram" *ngIf="lead.platform === 'ig'"></i>
                                                <i class="fas fa-globe" *ngIf="lead.platform !== 'fb' && lead.platform !== 'ig'"></i>
                                                <span>{{getPlatformDisplay(lead.platform)}}</span>
                                            </div>
                                        </div>

                                        <div class="lead-meta">
                                            <div class="lead-date">
                                                <i class="fas fa-calendar-alt"></i>
                                                {{lead.created_at | date:'dd/MM/yyyy HH:mm'}}
                                            </div>
                                            <div class="lead-status">
                                                <div class="status-display">
                                                    <span class="status-indicator"
                                                          [ngClass]="{
                                                            'status-whatsapp': lead.whatsappClickCount > 0,
                                                            'status-phone': lead.phoneClickCount > 0,
                                                            'status-both': lead.whatsappClickCount > 0 && lead.phoneClickCount > 0,
                                                            'status-new': (!lead.whatsappClickCount && !lead.phoneClickCount) || lead.status === 'New',
                                                            'status-closed': lead.status === 'Closed'
                                                          }">
                                                        <i class="fas fa-circle"></i>
                                                        <span class="status-text">
                                                            <span *ngIf="lead.whatsappClickCount > 0" class="click-count">
                                                                <i class="fab fa-whatsapp"></i> {{lead.whatsappClickCount}}x
                                                            </span>
                                                            <span *ngIf="lead.phoneClickCount > 0" class="click-count">
                                                                <i class="fas fa-phone"></i> {{lead.phoneClickCount}}x
                                                            </span>
                                                            <span *ngIf="!lead.whatsappClickCount && !lead.phoneClickCount">
                                                                {{lead.status || 'New'}}
                                                            </span>
                                                        </span>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="lead-actions">
                                        <button
                                            class="action-btn whatsapp-btn"
                                            (click)="contactViaWhatsAppForLead(lead, enquiry)"
                                            title="Contact via WhatsApp">
                                            <i class="fab fa-whatsapp"></i>
                                        </button>

                                        <button
                                            class="action-btn phone-btn"
                                            (click)="contactViaPhoneForLead(lead, enquiry)"
                                            title="Contact via Phone">
                                            <i class="fas fa-phone"></i>
                                        </button>

                                        <button
                                            class="action-btn delete-btn"
                                            (click)="deleteSpecificLead(lead, enquiry)"
                                            title="Delete this lead">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="empty-state">
                        <div class="empty-content">
                            <i class="fas fa-search"></i>
                            <h4>No enquiries found</h4>
                            <p>Try adjusting your filters or check back later</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <!-- ðŸ“± MOBILE CARD VIEW -->
    <div class="mobile-view">
        <div class="mobile-enquiries-container" *ngIf="!loading">
            <!-- Mobile Enquiry Cards -->
            <div class="mobile-enquiry-card" *ngFor="let enquiry of getDisplayEnquiries(); let cardIndex = index">
                <!-- Card Header with Venue Info -->
                <div class="mobile-card-header">
                    <div class="venue-info">
                        <div class="venue-name">
                            <i class="fas fa-map-marker-alt venue-icon"></i>
                            <strong>{{enquiry.venueName}}</strong>
                        </div>
                        <div *ngIf="selectedVenueFilter" class="lead-indicator">
                            <span class="lead-number">Lead {{enquiry.leadIndex}}</span>
                        </div>
                    </div>
                    <div class="leads-count-mobile">
                        <span class="leads-badge" 
                              [class.clickable-leads]="!selectedVenueFilter && enquiry.leadCount > 1"
                              (click)="!selectedVenueFilter && enquiry.leadCount > 1 ? toggleLeadsExpansion(enquiry) : null">
                            {{selectedVenueFilter ? '1' : enquiry.leadCount}}
                            <i class="fas fa-chevron-down expand-icon" 
                               *ngIf="!selectedVenueFilter && enquiry.leadCount > 1"
                               [class.rotated]="isLeadsExpanded(enquiry)"></i>
                        </span>
                        <small>{{selectedVenueFilter ? 'of ' + enquiry.originalLeadCount : 'leads'}}</small>
                    </div>
                </div>

                <!-- Contact Info Section -->
                <div class="mobile-contact-section">
                    <div class="contact-details">
                        <div class="user-name">
                            <i class="fas fa-user"></i>
                            {{getCurrentUser(enquiry).userName}}
                        </div>
                        <div class="user-contact">
                            <i class="fas fa-phone-alt"></i>
                            {{getCurrentUser(enquiry).userContact}}
                        </div>
                        <div class="user-email" *ngIf="getCurrentUser(enquiry).userEmail">
                            <i class="fas fa-envelope"></i>
                            {{getCurrentUser(enquiry).userEmail}}
                        </div>

                        <!-- Event Details for Mobile -->
                        <div class="mobile-event-details" *ngIf="getCurrentUser(enquiry).eventType || getCurrentUser(enquiry).eventDate">
                            <div class="event-type-mobile" *ngIf="getCurrentUser(enquiry).eventType">
                                <i class="fas fa-heart" *ngIf="getCurrentUser(enquiry).eventType.toLowerCase().includes('wedding')"></i>
                                <i class="fas fa-glass-cheers" *ngIf="getCurrentUser(enquiry).eventType.toLowerCase().includes('reception')"></i>
                                <i class="fas fa-birthday-cake" *ngIf="getCurrentUser(enquiry).eventType.toLowerCase().includes('birthday')"></i>
                                <i class="fas fa-calendar-check" *ngIf="!getCurrentUser(enquiry).eventType.toLowerCase().includes('wedding') && !getCurrentUser(enquiry).eventType.toLowerCase().includes('reception') && !getCurrentUser(enquiry).eventType.toLowerCase().includes('birthday')"></i>
                                <span>{{getEventTypeDisplay(getCurrentUser(enquiry).eventType)}}</span>
                            </div>
                            <div class="event-date-mobile" *ngIf="getCurrentUser(enquiry).eventDate">
                                <i class="fas fa-calendar"></i>
                                <span>{{getCurrentUser(enquiry).eventDate}}</span>
                            </div>
                        </div>
                        
                        <!-- Platform Source for Mobile -->
                        <div class="mobile-platform" *ngIf="getCurrentUser(enquiry).platform">
                            <div class="platform-mobile">
                                <i class="fab fa-facebook" *ngIf="getCurrentUser(enquiry).platform === 'fb'"></i>
                                <i class="fab fa-instagram" *ngIf="getCurrentUser(enquiry).platform === 'ig'"></i>
                                <i class="fas fa-globe" *ngIf="getCurrentUser(enquiry).platform !== 'fb' && getCurrentUser(enquiry).platform !== 'ig'"></i>
                                <span>{{getPlatformDisplay(getCurrentUser(enquiry).platform)}}</span>
                            </div>
                        </div>
                    </div>
                    <div class="contact-date">
                        <i class="fas fa-calendar-alt"></i>
                        <span>{{getCurrentUser(enquiry).created_at | date:'dd/MM/yyyy'}}</span>
                        <small>{{getCurrentUser(enquiry).created_at | date:'HH:mm'}}</small>
                    </div>
                </div>

                <!-- Live Activity Section -->
                <div class="mobile-activity-section" *ngIf="getLiveTrackingData(enquiry)">
                    <div class="activity-header">
                        <div class="live-status-mobile"
                             [class.online]="getLiveTrackingData(enquiry).websiteActivity.currentlyOnSite">
                            <i class="fas fa-circle"
                               [class.pulse-dot]="getLiveTrackingData(enquiry).websiteActivity.currentlyOnSite"></i>
                            <span>{{getLiveTrackingData(enquiry).websiteActivity.currentlyOnSite ? 'LIVE' : 'Offline'}}</span>
                        </div>
                        <div class="urgency-mobile">
                            <span class="urgency-badge"
                                  [class]="'urgency-' + getLiveTrackingData(enquiry).aiInsights.urgencyLevel.toLowerCase()">
                                {{getLiveTrackingData(enquiry).aiInsights.urgencyLevel}}
                            </span>
                        </div>
                    </div>
                    
                    <div class="activity-stats">
                        <div class="stat-item">
                            <i class="fas fa-eye"></i>
                            <span>{{getLiveTrackingData(enquiry).websiteActivity.totalVisits}} visits</span>
                        </div>
                        <div class="stat-item" *ngIf="getLiveTrackingData(enquiry).websiteActivity.currentlyOnSite">
                            <i class="fas fa-clock"></i>
                            <span>{{getLiveTrackingData(enquiry).websiteActivity.pagesViewed}} pages â€¢ {{getMinutes(getLiveTrackingData(enquiry).websiteActivity.timeOnSite)}}min</span>
                        </div>
                        <div class="stat-item warning" *ngIf="getLiveTrackingData(enquiry).competitorAnalysis.priceComparisons">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Price comparing</span>
                        </div>
                        <div class="stat-item" *ngIf="!getLiveTrackingData(enquiry).websiteActivity.currentlyOnSite">
                            <i class="fas fa-clock"></i>
                            <span>No recent activity</span>
                        </div>
                    </div>
                </div>

                <!-- Status and Interaction Section -->
                <div class="mobile-status-section">
                    <div class="mobile-status">
                        <span class="status-indicator"
                              [ngClass]="{
                                'status-whatsapp': getCurrentUser(enquiry).whatsappClickCount > 0,
                                'status-phone': getCurrentUser(enquiry).phoneClickCount > 0,
                                'status-both': getCurrentUser(enquiry).whatsappClickCount > 0 && getCurrentUser(enquiry).phoneClickCount > 0,
                                'status-new': (!getCurrentUser(enquiry).whatsappClickCount && !getCurrentUser(enquiry).phoneClickCount) || getCurrentUser(enquiry).status === 'New',
                                'status-closed': getCurrentUser(enquiry).status === 'Closed'
                              }">
                            <i class="fas fa-circle"></i>
                            <span class="status-text">
                                <span *ngIf="getCurrentUser(enquiry).whatsappClickCount > 0" class="click-count">
                                    <i class="fab fa-whatsapp"></i> {{getCurrentUser(enquiry).whatsappClickCount}}x
                                </span>
                                <span *ngIf="getCurrentUser(enquiry).phoneClickCount > 0" class="click-count">
                                    <i class="fas fa-phone"></i> {{getCurrentUser(enquiry).phoneClickCount}}x
                                </span>
                                <span *ngIf="!getCurrentUser(enquiry).whatsappClickCount && !getCurrentUser(enquiry).phoneClickCount">
                                    {{getCurrentUser(enquiry).status || 'New Lead'}}
                                </span>
                            </span>
                        </span>
                    </div>
                </div>

                <!-- AI Score and Predictions Section -->
                <div class="mobile-ai-section" *ngIf="getLiveTrackingData(enquiry)">
                    <div class="ai-probability-mobile">
                        <div class="probability-circle-mobile">
                            <div class="circle-progress-mobile"
                                 [style.background]="'conic-gradient(' + getBookingProbabilityColor(getLiveTrackingData(enquiry).aiInsights.bookingProbability) + ' ' + (getLiveTrackingData(enquiry).aiInsights.bookingProbability * 3.6) + 'deg, #e0e0e0 0deg)'">
                                <div class="circle-inner-mobile">
                                    <span class="percentage-mobile">{{getLiveTrackingData(enquiry).aiInsights.bookingProbability}}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="ai-details-mobile">
                            <div class="ai-score-label">AI Booking Score</div>
                            <div class="ai-predictions-mobile">
                                <div class="prediction-item-mobile" *ngIf="getLiveTrackingData(enquiry).aiInsights.decisionTimeline">
                                    <i class="fas fa-clock"></i>
                                    <small>{{getLiveTrackingData(enquiry).aiInsights.decisionTimeline}}</small>
                                </div>
                                <div class="prediction-item-mobile" *ngIf="getLiveTrackingData(enquiry).aiInsights.personalityType">
                                    <i class="fas fa-user-tie"></i>
                                    <small>{{getLiveTrackingData(enquiry).aiInsights.personalityType}}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- High Probability Alert -->
                    <div class="high-probability-alert-mobile"
                         *ngIf="getLiveTrackingData(enquiry).aiInsights.bookingProbability >= 80">
                        <i class="fas fa-fire"></i>
                        <span>HOT LEAD!</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mobile-action-buttons">
                    <button
                        class="action-btn whatsapp-btn mobile-action"
                        (click)="contactViaWhatsApp(enquiry)"
                        title="Contact via WhatsApp">
                        <i class="fab fa-whatsapp"></i>
                        <span>WhatsApp</span>
                    </button>

                    <button
                        class="action-btn phone-btn mobile-action"
                        (click)="contactViaPhone(enquiry)"
                        title="Contact via Phone">
                        <i class="fas fa-phone"></i>
                        <span>Call</span>
                    </button>

                    <button
                        class="action-btn insight-btn mobile-action"
                        (click)="openBehaviorPanel(enquiry)"
                        title="View Live Insights">
                        <i class="fas fa-chart-line"></i>
                        <span>Insights</span>
                    </button>

                    <button
                        class="action-btn delete-btn mobile-action"
                        (click)="deleteLead(enquiry)"
                        title="Delete Lead">
                        <i class="fas fa-trash-alt"></i>
                        <span>Delete</span>
                    </button>
                </div>

                <!-- Expanded Leads List for Mobile -->
                <div class="mobile-expanded-leads" *ngIf="isLeadsExpanded(enquiry) && !selectedVenueFilter">
                    <div class="expanded-header">
                        <h6><i class="fas fa-users"></i> All {{enquiry.leadCount}} Leads</h6>
                        <button class="collapse-btn-mobile" (click)="toggleLeadsExpansion(enquiry)">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>

                    <div class="mobile-leads-list">
                        <div class="mobile-lead-item" *ngFor="let lead of getAllLeadsForVenue(enquiry); let i = index">
                            <div class="lead-number-mobile">{{i + 1}}</div>
                            
                            <div class="lead-content-mobile">
                                <div class="lead-contact-mobile">
                                    <div class="contact-name-mobile">
                                        <i class="fas fa-user"></i>
                                        <strong>{{lead.userName}}</strong>
                                    </div>
                                    <div class="contact-phone-mobile">
                                        <i class="fas fa-phone-alt"></i>
                                        {{lead.userContact}}
                                    </div>
                                    <div class="contact-email-mobile" *ngIf="lead.userEmail">
                                        <i class="fas fa-envelope"></i>
                                        {{lead.userEmail}}
                                    </div>
                                </div>

                                <!-- Event Details for Mobile Expanded Lead -->
                                <div class="lead-event-mobile" *ngIf="lead.eventType || lead.eventDate">
                                    <div class="event-type-mobile" *ngIf="lead.eventType">
                                        <i class="fas fa-heart" *ngIf="lead.eventType.toLowerCase().includes('wedding')"></i>
                                        <i class="fas fa-glass-cheers" *ngIf="lead.eventType.toLowerCase().includes('reception')"></i>
                                        <i class="fas fa-birthday-cake" *ngIf="lead.eventType.toLowerCase().includes('birthday')"></i>
                                        <i class="fas fa-calendar-check" *ngIf="!lead.eventType.toLowerCase().includes('wedding') && !lead.eventType.toLowerCase().includes('reception') && !lead.eventType.toLowerCase().includes('birthday')"></i>
                                        <span>{{getEventTypeDisplay(lead.eventType)}}</span>
                                    </div>
                                    <div class="event-date-mobile" *ngIf="lead.eventDate">
                                        <i class="fas fa-calendar"></i>
                                        <span>{{lead.eventDate}}</span>
                                    </div>
                                </div>

                                <!-- Platform/Source for Mobile Expanded Lead -->
                                <div class="lead-platform-mobile" *ngIf="lead.platform">
                                    <div class="platform-badge-mobile">
                                        <i class="fab fa-facebook" *ngIf="lead.platform === 'fb'"></i>
                                        <i class="fab fa-instagram" *ngIf="lead.platform === 'ig'"></i>
                                        <i class="fas fa-globe" *ngIf="lead.platform !== 'fb' && lead.platform !== 'ig'"></i>
                                        <span>{{getPlatformDisplay(lead.platform)}}</span>
                                    </div>
                                </div>

                                <div class="lead-meta-mobile">
                                    <div class="lead-date-mobile">
                                        <i class="fas fa-calendar-alt"></i>
                                        {{lead.created_at | date:'dd/MM/yyyy HH:mm'}}
                                    </div>
                                    <div class="lead-status-mobile">
                                        <span class="status-indicator"
                                              [ngClass]="{
                                                'status-whatsapp': lead.whatsappClickCount > 0,
                                                'status-phone': lead.phoneClickCount > 0,
                                                'status-both': lead.whatsappClickCount > 0 && lead.phoneClickCount > 0,
                                                'status-new': (!lead.whatsappClickCount && !lead.phoneClickCount) || lead.status === 'New',
                                                'status-closed': lead.status === 'Closed'
                                              }">
                                            <i class="fas fa-circle"></i>
                                            <span class="status-text">
                                                <span *ngIf="lead.whatsappClickCount > 0" class="click-count">
                                                    <i class="fab fa-whatsapp"></i> {{lead.whatsappClickCount}}x
                                                </span>
                                                <span *ngIf="lead.phoneClickCount > 0" class="click-count">
                                                    <i class="fas fa-phone"></i> {{lead.phoneClickCount}}x
                                                </span>
                                                <span *ngIf="!lead.whatsappClickCount && !lead.phoneClickCount">
                                                    New
                                                </span>
                                            </span>
                                        </span>
                                    </div>
                                </div>

                                <div class="lead-actions-mobile">
                                    <button
                                        class="action-btn whatsapp-btn"
                                        (click)="contactViaWhatsAppForLead(lead, enquiry)"
                                        title="Contact via WhatsApp">
                                        <i class="fab fa-whatsapp"></i>
                                    </button>

                                    <button
                                        class="action-btn phone-btn"
                                        (click)="contactViaPhoneForLead(lead, enquiry)"
                                        title="Contact via Phone">
                                        <i class="fas fa-phone"></i>
                                    </button>

                                    <button
                                        class="action-btn delete-btn"
                                        (click)="deleteSpecificLead(lead, enquiry)"
                                        title="Delete this lead">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Empty State -->
        <div class="mobile-empty-state" *ngIf="!loading && getDisplayEnquiries().length === 0">
            <div class="empty-content">
                <i class="fas fa-search"></i>
                <h4>No enquiries found</h4>
                <p>Try adjusting your filters or check back later</p>
            </div>
        </div>

        <!-- Mobile Loading State -->
        <div class="mobile-loading" *ngIf="loading">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading enquiries...</p>
            </div>
        </div>

        <!-- Mobile Pagination -->
        <div class="mobile-pagination" *ngIf="!loading && getDisplayEnquiries().length > 0">
            <p-paginator 
                [rows]="10" 
                [totalRecords]="getDisplayEnquiries().length"
                [pageLinkSize]="3"
                [showCurrentPageReport]="true"
                currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries">
            </p-paginator>
        </div>
    </div>

<div class="modal-overlay" *ngIf="showAddEnquiryModal" (click)="closeAddEnquiryModal()">
    <div class="add-enquiry-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> Add Manual Enquiries</h3>
            <button class="close-btn" (click)="closeAddEnquiryModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="enquiry-form-container">
            <!-- Venue Selection Section -->
            <div class="venue-selection-section">
                <div class="form-group">
                    <label>Select Venue(s) *</label>
                    <p-multiSelect
                        [options]="venueOptions"
                        [(ngModel)]="selectedVenues"
                        placeholder="Search and select venues..."
                        [filter]="true"
                        filterBy="label"
                        optionLabel="label"
                        optionValue="value"
                        [showClear]="true"
                        [maxSelectedLabels]="2"
                        selectedItemsLabel="{0} venues selected"
                        styleClass="venue-multi-select">
                    </p-multiSelect>
                    <small class="help-text">
                        <i class="fas fa-info-circle"></i>
                        Select one or more venues. Each lead will be added to all selected venues.
                    </small>
                </div>
            </div>

            <!-- Bulk Leads Entry Section -->
            <div class="bulk-leads-section">
                <div class="section-header">
                    <h4><i class="fas fa-users"></i> Customer Details</h4>
                    <div class="bulk-actions">
                        <button type="button"
                                class="btn btn-outline-primary btn-sm"
                                (click)="addNewLead()"
                                [disabled]="leadEntries.length >= 10">
                            <i class="fas fa-plus"></i>
                            Add Lead
                        </button>
                        <button type="button"
                                class="btn btn-outline-secondary btn-sm"
                                (click)="clearAllLeads()"
                                *ngIf="leadEntries.length > 1">
                            <i class="fas fa-trash"></i>
                            Clear All
                        </button>
                    </div>
                </div>

                <div class="leads-container">
                    <div class="lead-entry"
                         *ngFor="let lead of leadEntries; let i = index; trackBy: trackByLeadId">
                        <div class="lead-header">
                            <span class="lead-number">Lead #{{ i + 1 }}</span>
                            <button type="button"
                                    class="remove-lead-btn"
                                    (click)="removeLead(i)"
                                    *ngIf="leadEntries.length > 1"
                                    title="Remove this lead">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="lead-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Customer Name *</label>
                                    <input type="text"
                                           [(ngModel)]="lead.userName"
                                           placeholder="Enter customer name"
                                           class="form-control"
                                           [class.error]="!lead.userName && showValidationErrors">
                                </div>

                                <div class="form-group">
                                    <label>Contact Number *</label>
                                    <input type="tel"
                                           [(ngModel)]="lead.userContact"
                                           placeholder="Enter contact number"
                                           class="form-control"
                                           [class.error]="!lead.userContact && showValidationErrors"
                                           (input)="validateContactNumber(lead)">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email"
                                           [(ngModel)]="lead.userEmail"
                                           placeholder="Enter email address"
                                           class="form-control"
                                           [class.error]="lead.userEmail && !isValidEmail(lead.userEmail) && showValidationErrors">
                                </div>

                                <div class="form-group">
                                    <label>Status</label>
                                    <p-dropdown
                                        [options]="statusOptions"
                                        [(ngModel)]="lead.status"
                                        placeholder="Select status"
                                        optionLabel="label"
                                        optionValue="value"
                                        styleClass="status-dropdown"
                                        >
                                    </p-dropdown>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Enquiry Date *</label>
                                    <p-calendar
                                        [(ngModel)]="lead.enquiryDate"
                                        [showTime]="true"
                                        [hourFormat]="24"
                                        dateFormat="dd/mm/yy"
                                        placeholder="Select date & time"
                                        styleClass="calendar-control"
                                        >
                                    </p-calendar>
                                </div>

                                <div class="form-group">
                                    <label>Notes</label>
                                    <textarea
                                        [(ngModel)]="lead.notes"
                                        placeholder="Add notes for this lead..."
                                        class="form-control textarea-control"
                                        rows="2">
                                    </textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="add-more-section" *ngIf="leadEntries.length < 10">
                    <button type="button"
                            class="btn btn-dashed"
                            (click)="addNewLead()">
                        <i class="fas fa-plus"></i>
                        Add Another Lead ({{ leadEntries.length }}/10)
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="form-actions">
                <button type="button"
                        class="btn btn-secondary"
                        (click)="closeAddEnquiryModal()">
                    Cancel
                </button>
                <button type="button"
                        class="btn btn-primary"
                        (click)="submitBulkEnquiries()"
                        [disabled]="!isFormValid() || submittingEnquiry">
                    <i class="fas fa-save" *ngIf="!submittingEnquiry"></i>
                    <i class="fas fa-spinner fa-spin" *ngIf="submittingEnquiry"></i>
                    {{ submittingEnquiry ? 'Saving...' : 'Save All Enquiries' }}
                </button>
            </div>

            <!-- Summary Section -->
            <div class="summary-section" *ngIf="selectedVenues.length > 0 && leadEntries.length > 0">
                <div class="summary-info">
                    <i class="fas fa-info-circle"></i>
                    <span>
                        Total entries to be created:
                        <strong>{{ selectedVenues.length }} venue(s) Ã— {{ getValidLeadsCount() }} lead(s) = {{ selectedVenues.length * getValidLeadsCount() }} enquiries</strong>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ðŸ”® REVOLUTIONARY BEHAVIOR TRACKING PANEL -->
<div class="behavior-panel-overlay" *ngIf="showBehaviorPanel" (click)="closeBehaviorPanel()">
    <div class="behavior-panel" (click)="$event.stopPropagation()" *ngIf="selectedLeadForTracking">
        <div class="panel-header">
            <div class="panel-title">
                <i class="fas fa-brain"></i>
                <h3>ðŸ”® Live Behavior Analysis</h3>
                <div class="lead-info">
                    <span class="lead-name">{{selectedLeadForTracking.userName}}</span>
                    <span class="venue-name">- {{selectedLeadForTracking.venueName}}</span>
                </div>
            </div>
            <button class="close-btn" (click)="closeBehaviorPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="panel-content" *ngIf="getLiveTrackingData(selectedLeadForTracking)">
            <!-- AI Score Dashboard -->
            <div class="ai-dashboard">
                <div class="score-card main-score">
                    <div class="score-circle large">
                        <div class="circle-bg">
                            <div class="circle-fill"
                                 [style.background]="'conic-gradient(' + getBookingProbabilityColor(getLiveTrackingData(selectedLeadForTracking).aiInsights.bookingProbability) + ' ' + (getLiveTrackingData(selectedLeadForTracking).aiInsights.bookingProbability * 3.6) + 'deg, #e0e0e0 0deg)'">
                                <div class="circle-inner">
                                    <span class="percentage">{{getLiveTrackingData(selectedLeadForTracking).aiInsights.bookingProbability}}%</span>
                                    <small>Booking Probability</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="score-grid">
                    <div class="score-card">
                        <div class="score-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="score-details">
                            <span class="score-label">Urgency</span>
                            <span class="score-value" [class]="getUrgencyBadgeClass(getLiveTrackingData(selectedLeadForTracking).aiInsights.urgencyLevel)">
                                {{getLiveTrackingData(selectedLeadForTracking).aiInsights.urgencyLevel}}
                            </span>
                        </div>
                    </div>

                    <div class="score-card">
                        <div class="score-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="score-details">
                            <span class="score-label">Personality</span>
                            <span class="score-value">{{getLiveTrackingData(selectedLeadForTracking).aiInsights.personalityType}}</span>
                        </div>
                    </div>

                    <div class="score-card">
                        <div class="score-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="score-details">
                            <span class="score-label">Timeline</span>
                            <span class="score-value">{{getLiveTrackingData(selectedLeadForTracking).aiInsights.decisionTimeline}}</span>
                        </div>
                    </div>

                    <div class="score-card">
                        <div class="score-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="score-details">
                            <span class="score-label">Communication</span>
                            <span class="score-value">{{getLiveTrackingData(selectedLeadForTracking).aiInsights.communicationStyle}}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Website Activity -->
            <div class="activity-section">
                <h4>
                    <i class="fas fa-globe"></i>
                    Website Activity
                    <span class="live-indicator"
                          *ngIf="getLiveTrackingData(selectedLeadForTracking).websiteActivity.currentlyOnSite">
                        <i class="fas fa-circle pulse-dot"></i>
                        LIVE NOW
                    </span>
                </h4>

                <div class="activity-stats">
                    <div class="stat-item">
                        <i class="fas fa-eye"></i>
                        <div>
                            <span class="stat-value">{{getLiveTrackingData(selectedLeadForTracking).websiteActivity.totalVisits}}</span>
                            <span class="stat-label">Total Visits</span>
                        </div>
                    </div>

                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <div>
                            <span class="stat-value">{{getMinutes(getLiveTrackingData(selectedLeadForTracking).websiteActivity.averageSessionTime)}}m</span>
                            <span class="stat-label">Avg Session</span>
                        </div>
                    </div>

                    <div class="stat-item">
                        <i class="fas fa-mouse-pointer"></i>
                        <div>
                            <span class="stat-value">{{getLiveTrackingData(selectedLeadForTracking).websiteActivity.heatmapData.galleryClicks}}</span>
                            <span class="stat-label">Gallery Clicks</span>
                        </div>
                    </div>

                    <div class="stat-item">
                        <i class="fas fa-dollar-sign"></i>
                        <div>
                            <span class="stat-value">{{getLiveTrackingData(selectedLeadForTracking).websiteActivity.heatmapData.pricingViews}}</span>
                            <span class="stat-label">Pricing Views</span>
                        </div>
                    </div>
                </div>

                <div class="last-activity">
                    <i class="fas fa-history"></i>
                    <span>Last seen: {{formatTimeAgo(getLiveTrackingData(selectedLeadForTracking).websiteActivity.lastVisit)}}</span>
                </div>
            </div>

            <!-- Competitor Analysis -->
            <div class="competitor-section"
                 *ngIf="getLiveTrackingData(selectedLeadForTracking).competitorAnalysis.otherVenuesViewed > 0">
                <h4>
                    <i class="fas fa-exclamation-triangle"></i>
                    Competitor Intelligence
                </h4>

                <div class="competitor-warning">
                    <i class="fas fa-shield-alt"></i>
                    <div>
                        <strong>Alert:</strong> Client has viewed {{getLiveTrackingData(selectedLeadForTracking).competitorAnalysis.otherVenuesViewed}} competitor venues
                        <div class="competitor-list">
                            <span *ngFor="let competitor of getLiveTrackingData(selectedLeadForTracking).competitorAnalysis.competitorNames"
                                  class="competitor-tag">
                                {{competitor}}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="last-competitor-visit"
                     *ngIf="getLiveTrackingData(selectedLeadForTracking).competitorAnalysis.priceComparisons">
                    <i class="fas fa-balance-scale"></i>
                    <span>Price comparison detected: {{formatTimeAgo(getLiveTrackingData(selectedLeadForTracking).competitorAnalysis.lastCompetitorVisit)}}</span>
                </div>
            </div>

            <!-- AI Insights & Recommendations -->
            <div class="insights-section" *ngIf="getAIInsights(selectedLeadForTracking)">
                <h4>
                    <i class="fas fa-lightbulb"></i>
                    AI Insights & Recommendations
                </h4>

                <div class="insights-list">
                    <div class="insight-item"
                         *ngFor="let insight of getAIInsights(selectedLeadForTracking).insights">
                        <i class="fas fa-brain"></i>
                        <span>{{insight}}</span>
                    </div>
                </div>

                <div class="recommendations">
                    <h5>
                        <i class="fas fa-rocket"></i>
                        Recommended Actions
                    </h5>
                    <div class="action-list">
                        <div class="action-item"
                             *ngFor="let action of getAIInsights(selectedLeadForTracking).recommendedActions">
                            <i class="fas fa-chevron-right"></i>
                            <span>{{action}}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Communication Pattern -->
            <div class="communication-section">
                <h4>
                    <i class="fas fa-chart-line"></i>
                    Communication Pattern
                </h4>

                <div class="comm-stats">
                    <div class="comm-item">
                        <i class="fab fa-whatsapp whatsapp-icon"></i>
                        <div>
                            <span class="comm-label">WhatsApp Response</span>
                            <span class="comm-value">{{getLiveTrackingData(selectedLeadForTracking).communicationPattern.whatsappResponseTime}} minutes avg</span>
                        </div>
                    </div>

                    <div class="comm-item">
                        <i class="fas fa-phone phone-icon"></i>
                        <div>
                            <span class="comm-label">Call Duration</span>
                            <span class="comm-value">{{getMinutes(getLiveTrackingData(selectedLeadForTracking).communicationPattern.phoneCallDuration)}} minutes avg</span>
                        </div>
                    </div>

                    <div class="comm-item">
                        <i class="fas fa-star"></i>
                        <div>
                            <span class="comm-label">Preferred Method</span>
                            <span class="comm-value">{{getLiveTrackingData(selectedLeadForTracking).communicationPattern.preferredContactMethod}}</span>
                        </div>
                    </div>

                    <div class="comm-item">
                        <i class="fas fa-clock"></i>
                        <div>
                            <span class="comm-label">Best Contact Time</span>
                            <span class="comm-value">{{getLiveTrackingData(selectedLeadForTracking).aiInsights.bestContactTime}}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ðŸ§  AI COMPREHENSIVE SUMMARY -->
            <div class="ai-summary-section">
                <h4>
                    <i class="fas fa-brain"></i>
                    ðŸ§  AI Comprehensive Summary
                </h4>
                
                <div class="ai-summary-card">
                    <div class="summary-header">
                        <div class="ai-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="ai-info">
                            <span class="ai-name">EazyVenue AI Assistant</span>
                            <span class="analysis-timestamp">Analysis updated: {{formatTimeAgo(getLiveTrackingData(selectedLeadForTracking).aiInsights.lastAnalysis)}}</span>
                        </div>
                    </div>
                    
                    <div class="ai-summary-content">
                        <div class="summary-text">
                            {{generateAISummary(selectedLeadForTracking)}}
                        </div>
                        
                        <div class="key-points">
                            <h5><i class="fas fa-key"></i> Key Points:</h5>
                            <div class="points-list">
                                <div class="point-item" 
                                     *ngFor="let point of getAIKeyPoints(selectedLeadForTracking)"
                                     [class]="point.type">
                                    <i [class]="point.icon"></i>
                                    <span>{{point.text}}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="next-steps">
                            <h5><i class="fas fa-route"></i> Recommended Next Steps:</h5>
                            <div class="steps-list">
                                <div class="step-item"
                                     *ngFor="let step of getAINextSteps(selectedLeadForTracking); let i = index"
                                     [class.priority]="i === 0">
                                    <span class="step-number">{{i + 1}}</span>
                                    <span class="step-text">{{step}}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="confidence-score">
                            <div class="confidence-label">
                                <i class="fas fa-chart-bar"></i>
                                AI Confidence Level:
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" 
                                     [style.width.%]="getLiveTrackingData(selectedLeadForTracking).aiInsights.confidenceScore"
                                     [class]="getConfidenceClass(getLiveTrackingData(selectedLeadForTracking).aiInsights.confidenceScore)">
                                </div>
                            </div>
                            <span class="confidence-percentage">{{getLiveTrackingData(selectedLeadForTracking).aiInsights.confidenceScore}}%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="panel-actions">
                <button class="action-btn whatsapp-btn"
                        (click)="contactViaWhatsApp(selectedLeadForTracking)">
                    <i class="fab fa-whatsapp"></i>
                    Contact via WhatsApp
                </button>
                <button class="action-btn phone-btn"
                        (click)="contactViaPhone(selectedLeadForTracking)">
                    <i class="fas fa-phone"></i>
                    Call Now
                </button>
                <button class="action-btn email-btn">
                    <i class="fas fa-envelope"></i>
                    Send Email
                </button>
            </div>
        </div>
    </div>
</div>


<!-- CSV Import Modal -->
<div class="modal-overlay" *ngIf="showImportCsvModal" (click)="closeImportCsvModal()">
    <div class="csv-import-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>
                <i class="fas fa-file-csv"></i>
                Import CSV Leads
            </h3>
            <button class="close-btn" (click)="closeImportCsvModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-content">
            <div class="import-instructions">
                <div class="instruction-item">
                    <i class="fas fa-info-circle"></i>
                    <span>Upload a CSV file with leads data. The file should contain columns for: full_name, phone_number, email, etc.</span>
                </div>
                <div class="instruction-item">
                    <i class="fas fa-lightbulb"></i>
                    <span>Supported format: Comma-separated values (CSV) exported from Facebook/Instagram lead forms</span>
                </div>
            </div>

            <!-- Venue Selection -->
            <div class="form-group">
                <label>
                    <i class="fas fa-building"></i>
                    Select Venue for Import
                </label>
                <p-dropdown 
                    [options]="venueOptions" 
                    [(ngModel)]="importVenueId"
                    optionLabel="venueName" 
                    optionValue="value"
                    placeholder="Choose a venue..."
                    [style]="{'width': '100%'}"
                    styleClass="venue-dropdown">
                </p-dropdown>
            </div>

            <!-- File Upload -->
            <div class="form-group">
                <label>
                    <i class="fas fa-upload"></i>
                    Select CSV File
                </label>
                <div class="file-upload-container">
                    <input 
                        type="file" 
                        #csvFileInput
                        accept=".csv,.tsv,.txt"
                        (change)="onCsvFileSelected($event)"
                        class="file-input">
                    <div class="file-upload-area" (click)="csvFileInput.click()">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <span *ngIf="!csvFile">Click to select CSV file or drag and drop</span>
                            <span *ngIf="csvFile" class="selected-file">
                                <i class="fas fa-file-csv"></i>
                                {{csvFile.name}}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Format Help Button -->
                <div class="format-help">
                    <button class="format-btn" (click)="showExpectedFormat()" title="Show Expected CSV Format">
                        <i class="fas fa-question-circle"></i> CSV Format Help
                    </button>
                </div>
            </div>

            <!-- Preview Data -->
            <div class="csv-preview" *ngIf="csvData.length > 0">
                <h4>
                    <i class="fas fa-eye"></i>
                    Data Preview ({{csvData.length}} records found)
                    <button class="debug-btn" (click)="debugCsvData()" title="Debug CSV Data">
                        <i class="fas fa-bug"></i> Debug
                    </button>
                </h4>
                <div class="preview-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Event Type</th>
                                <th>Event Date</th>
                                <th>Platform</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let row of csvData.slice(0, 5)">
                                <td>{{row['full_name'] || '-'}}</td>
                                <td>{{row['phone_number']?.replace('p:', '') || '-'}}</td>
                                <td>{{row['email'] || '-'}}</td>
                                <td>{{row['are_you_hosting_an_event_?'] || '-'}}</td>
                                <td>{{row['what_is_your_date_of_event?'] || '-'}}</td>
                                <td>{{row['platform'] || '-'}}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="preview-note" *ngIf="csvData.length > 5">
                        <i class="fas fa-info-circle"></i>
                        Showing first 5 records. {{csvData.length - 5}} more records will be imported.
                    </div>
                </div>
            </div>

            <!-- Import Results -->
            <div class="import-results" *ngIf="csvImportResults">
                <div class="results-summary">
                    <i class="fas fa-chart-pie"></i>
                    <h4>Import Results</h4>
                    <div class="results-stats">
                        <div class="stat-item success">
                            <span class="stat-number">{{csvImportResults.successful}}</span>
                            <span class="stat-label">Successful</span>
                        </div>
                        <div class="stat-item total">
                            <span class="stat-number">{{csvImportResults.total}}</span>
                            <span class="stat-label">Total</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button 
                class="btn btn-secondary" 
                (click)="closeImportCsvModal()"
                [disabled]="processingCsvImport">
                Cancel
            </button>
            <button 
                class="btn btn-primary import-btn" 
                (click)="processCsvImport()"
                [disabled]="!importVenueId || !csvData.length || processingCsvImport">
                <i class="fas fa-spinner fa-spin" *ngIf="processingCsvImport"></i>
                <i class="fas fa-upload" *ngIf="!processingCsvImport"></i>
                {{processingCsvImport ? 'Importing...' : 'Import ' + csvData.length + ' Records'}}
            </button>
        </div>
    </div>
</div>

<p-toast key="toastmsg" position="top-right" [style]="{'z-index': '9999', 'margin-top': '70px'}" [preventOpenDuplicates]="true" [preventDuplicates]="true" [showTransformOptions]="'translateX(100%)'" [hideTransformOptions]="'translateX(100%)'"></p-toast>
